@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using Project2EmailNight.Entities
@using Project2EmailNight.Context
@inject UserManager<AppUser> UserManager

@{
    var currentUser = await UserManager.GetUserAsync(User);
    ViewData["UserFirstName"] = currentUser?.FirstName ?? "Kullanıcı";
    ViewData["UserLastName"] = currentUser?.LastName ?? "";
    ViewData["UserEmail"] = currentUser?.Email ?? "";
    ViewData["UserInitials"] = currentUser != null
        ? $"{currentUser.FirstName?.Substring(0, 1)}{currentUser.LastName?.Substring(0, 1)}".ToUpper()
        : "??";

    // TÜM SAYILARI HESAPLA
    var unreadMessages = new List<Message>();
    int inboxCount = 0;
    int starredCount = 0;
    int sentCount = 0;
    int draftCount = 0;
    int trashCount = 0;

    if (currentUser != null)
    {
        var serviceProvider = ViewContext.HttpContext.RequestServices;
        var dbContext = serviceProvider.GetRequiredService<EmailContext>();

        // Okunmamış mesajlar (dropdown için)
        unreadMessages = dbContext.Messages
            .Where(m => m.ReceiverId == currentUser.Id && !m.IsRead && !m.IsDeletedByReceiver && !m.IsDraft)
            .OrderByDescending(m => m.SentDate)
            .Take(5)
            .Include(m => m.Sender)
            .ToList();

        // Gelen Kutusu
        inboxCount = dbContext.Messages
            .Count(m => m.ReceiverId == currentUser.Id && !m.IsDeletedByReceiver && !m.IsDraft);

        // Yıldızlı
        starredCount = dbContext.Messages
            .Count(m => m.ReceiverId == currentUser.Id && m.IsStarred && !m.IsDeletedByReceiver);

        // Gönderilenler
        sentCount = dbContext.Messages
            .Count(m => m.SenderId == currentUser.Id && !m.IsDraft && !m.IsDeletedBySender);

        // Taslaklar
        draftCount = dbContext.Messages
            .Count(m => m.SenderId == currentUser.Id && m.IsDraft && !m.IsDeletedBySender);

        // Çöp Kutusu
        trashCount = dbContext.Messages
            .Count(m => (m.ReceiverId == currentUser.Id && m.IsDeletedByReceiver)
                     || (m.SenderId == currentUser.Id && m.IsDeletedBySender));
    }
    // Kategorileri çek
    var userCategories = new List<Category>();
    if (currentUser != null)
    {
        var serviceProvider = ViewContext.HttpContext.RequestServices;
        var dbContext = serviceProvider.GetRequiredService<EmailContext>();

        userCategories = dbContext.Categories
            .Where(c => c.UserId == currentUser.Id)
            .OrderBy(c => c.Name)
            .ToList();
    }
    ViewData["UserCategories"] = userCategories;

    ViewData["UnreadMessages"] = unreadMessages;
    ViewData["UnreadCount"] = unreadMessages.Count;
    ViewData["InboxCount"] = inboxCount;
    ViewData["StarredCount"] = starredCount;
    ViewData["SentCount"] = sentCount;
    ViewData["DraftCount"] = draftCount;
    ViewData["TrashCount"] = trashCount;
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>@ViewData["Title"] - Project2EmailNight</title>
    <link rel="icon" href="~/assets/images/favicon-32x32.png" type="image/png" />
    <link href="~/assets/plugins/simplebar/css/simplebar.css" rel="stylesheet" />
    <link href="~/assets/plugins/perfect-scrollbar/css/perfect-scrollbar.css" rel="stylesheet" />
    <link href="~/assets/plugins/metismenu/css/metisMenu.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="~/assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600&family=Roboto&display=swap" />
    <link rel="stylesheet" href="~/assets/css/icons.css" />
    <link rel="stylesheet" href="~/assets/css/app.css" />
    <link rel="stylesheet" href="~/assets/css/dark-sidebar.css" />
    <link rel="stylesheet" href="~/assets/css/dark-theme.css" />
    <!-- Summernote CSS -->
    <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css" rel="stylesheet">
</head>
<body>

    @if (ViewData["IsEmailPage"] != null && (bool)ViewData["IsEmailPage"])
    {
        <!-- ============ EMAIL SAYFASI - ÖZEL YAPI ============ -->
        <div class="wrapper">
            <!-- Header -->
            <partial name="_Header"  />

            <!-- Email Content - Direkt RenderBody (Wrapper YOK!) -->
            @RenderBody()

            <!-- Overlay -->
            <div class="overlay toggle-btn-mobile"></div>
        </div>
    }
    else
    {
        <!-- ============ NORMAL SAYFA - STANDART YAPI ============ -->
        <div class="wrapper">
            <!-- Sidebar -->
            <partial name="_Sidebar" />

            <!-- Header -->
            <partial name="_Header" />

            <!-- Page Wrapper -->
            <div class="page-wrapper">
                <div class="page-content-wrapper">
                    <div class="page-content">
                        @RenderBody()
                    </div>
                </div>
            </div>

            <!-- Overlay -->
            <div class="overlay toggle-btn-mobile"></div>

            <!-- Back to Top -->
            <a href="javaScript:;" class="back-to-top"><i class='bx bxs-up-arrow-alt'></i></a>

            <!-- Footer -->
            <div class="footer">
                <p class="mb-0">Project2EmailNight &copy; 2026</p>
            </div>
        </div>
    }

    <!-- Template JS -->
    <script src="~/assets/js/bootstrap.bundle.min.js"></script>
    <script src="~/assets/js/jquery.min.js"></script>
    <script src="~/assets/plugins/simplebar/js/simplebar.min.js"></script>
    <script src="~/assets/plugins/metismenu/js/metisMenu.min.js"></script>
    <script src="~/assets/plugins/perfect-scrollbar/js/perfect-scrollbar.js"></script>
    <script src="~/assets/js/app.js"></script>

    <!-- Summernote JS -->
    <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>
    @await RenderSectionAsync("Scripts", required: false)

    <!-- Compose Modal -->
    <div class="modal fade" id="composeModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class='bx bx-envelope me-2'></i>Yeni Mesaj
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="composeForm">
                        <!-- Alıcı -->
                        <div class="mb-3">
                            <label class="form-label">Alıcı</label>
                            <input type="email" class="form-control" id="composeTo" name="to" placeholder="email@example.com" required>
                        </div>

                        <!-- Konu -->
                        <div class="mb-3">
                            <label class="form-label">Konu</label>
                            <input type="text" class="form-control" id="composeSubject" name="subject" placeholder="Mesaj konusu" required>
                        </div>

                        <!-- Mesaj -->
                        <div class="mb-3">
                            <label class="form-label">Mesaj</label>
                            <textarea id="composeBody" name="body"></textarea>
                        </div>

                        <!-- Kategoriler -->
                        <div class="mb-3">
                            <label class="form-label">Kategoriler (İsteğe bağlı)</label>
                            <select class="form-select" id="composeCategories" name="categories" multiple>
                                @foreach (var cat in userCategories)
                                {
                                    <option value="@cat.Id">@cat.Name</option>
                                }
                            </select>
                            <small class="text-muted">Ctrl/Cmd tuşu ile birden fazla seçebilirsiniz</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class='bx bx-x me-1'></i>İptal
                    </button>
                    <button type="button" class="btn btn-primary" id="sendMessageBtn">
                        <i class='bx bx-send me-1'></i>Gönder
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
               // Summernote başlat
        $(document).ready(function() {
            $('#composeBody').summernote({
                height: 250,
                placeholder: 'Mesajınızı yazın...',
                toolbar: [
                    ['style', ['bold', 'italic', 'underline', 'clear']],
                    ['font', ['strikethrough']],
                    ['color', ['color']],
                    ['para', ['ul', 'ol', 'paragraph']],
                    ['insert', ['link']],
                    ['view', ['fullscreen', 'codeview']]
                ]
            });
        });

        // Modal açma fonksiyonu
        function openComposeModal(to = '', subject = '') {
            $('#composeTo').val(to);
            $('#composeSubject').val(subject);
            $('#composeBody').summernote('code', ''); // Rich text temizle
            $('#composeCategories').val([]);
            $('#composeModal').modal('show');
        }

        // Mesaj gönder
        $(document).ready(function() {
            $('#sendMessageBtn').on('click', function() {
                       var formData = {
            to: $('#composeTo').val(),
            subject: $('#composeSubject').val(),
            body: $('#composeBody').summernote('code'), // Rich text içeriğini al
            categories: $('#composeCategories').val() || []
        };

                if (!formData.to || !formData.subject || !formData.body) {
                    alert('Lütfen tüm alanları doldurun');
                    return;
                }

                $.ajax({
                    url: '/Email/Compose',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function(result) {
                        if (result.success) {
                            $('#composeModal').modal('hide');
                            alert('Mesaj başarıyla gönderildi!');
                            location.reload();
                        } else {
                            alert(result.message || 'Gönderim başarısız');
                        }
                    },
                    error: function() {
                        alert('Bir hata oluştu');
                    }
                });
            });
        });
    </script>

</body>
</html>
